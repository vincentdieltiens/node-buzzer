{"version":3,"sources":["ps2/buzzer.js"],"names":["HID","signals","signalsEqual","a","b","i","searchSignalIndex","signal","length","Ps2Buzzer","device","eventListeners","lights","handlers","timeout","waitForDevice","interval","startTime","Date","now","tick","currentTime","clearInterval","triggerEvent","e","init","setInterval","on","signalIndex","controllerIndex","Math","floor","buttonIndex","key","callHandlers","error","light","close","controllerIndexes","value","Error","message","ctrl","j","parseInt","write","times","duration","count","lightOn","lightOff"],"mappings":"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","file":"buzzer.js","sourcesContent":["'use strict';\n\nimport * as HID from 'node-hid';\nimport { Buzzer } from '../Buzzer';\nimport { BuzzerNotFoundError } from '../BuzzerNotFoundError';\nimport { BuzzerReadError } from '../BuzzerReadError';\n\nvar signals = [\n\t// controller 1\n\t[0, 0, 1, 0, 240],\n\t[0, 0, 16, 0, 240],\n\t[0, 0, 8, 0, 240],\n\t[0, 0, 4, 0, 240],\n\t[0, 0, 2, 0, 240],\n\t// controller 2\n\t[0, 0, 32, 0, 240],\n\t[0, 0, 0, 2, 240],\n\t[0, 0, 0, 1, 240],\n\t[0, 0, 128, 0, 240],\n\t[0, 0, 64, 0, 240],\n\t// controller 3\n\t[0, 0, 0, 4, 240],\n\t[0, 0, 0, 64, 240],\n\t[0, 0, 0, 32, 240],\n\t[0, 0, 0, 16, 240],\n\t[0, 0, 0, 8, 240],\n\t// controller 4\n\t[0, 0, 0, 128, 240],\n\t[0, 0, 0, 0, 248],\n\t[0, 0, 0, 0, 244],\n\t[0, 0, 0, 0, 242],\n\t[0, 0, 0, 0, 241]\n]\n\nfunction signalsEqual(a, b) {\n\tfor(var i=0; i < 5; i++) {\n\t\tif (a[i] != b[i]) {\n\t\t\treturn false;\n\t\t}\n\t}\n\treturn true;\n}\n\nfunction searchSignalIndex(signal)/*: number*/ {\n\tfor (var i=0; i < signals.length; i++) {\n\t\tif (signalsEqual(signal, signals[i])) {\n\t\t\treturn i;\n\t\t}\n\t}\n\treturn -1;\n}\n\nexport class Ps2Buzzer extends Buzzer {\n\tconstructor(device=null) {\n\t\tsuper();\n\t\tthis.eventListeners = { 'ready': [], 'leave': [], 'error': [] };\n\t\tthis.lights = [0x0, 0x0, 0x0, 0x0];\n\t\tthis.handlers = [];\n\t}\n\n\tconnect(timeout) {\n\t\tthis.timeout = timeout;\n\t\tthis.waitForDevice();\n\t}\n\n\twaitForDevice() {\n\t\tlet interval;\n\t\tlet startTime = Date.now();\n\t\tlet tick = () => {\n\t\t\tlet currentTime = Date.now();\n\t\t\tif (currentTime - startTime > this.timeout) {\n\t\t\t\tclearInterval(interval);\n\t\t\t\tthis.triggerEvent('error', new BuzzerNotFoundError('PS2 buzzer not found'));\n\t\t\t}\n\n\t\t\tif (!this.device) {\n\t\t\t\ttry {\n\t\t\t\t\tthis.device = new HID.HID(0x054c, 0x1000);\n\t\t\t\t\tclearInterval(interval);\n\t\t\t\t} catch(e) {\n\t\t\t\t\treturn; // Do not init at this tick\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tclearInterval(interval);\n\t\t\t}\n\n\t\t\tthis.init();\n\t\t};\n\t\tinterval = setInterval(tick, 1000);\n\t\ttick();\n\t}\n\n\tinit(device) {\n\t\tthis.triggerEvent('ready');\n\t\tthis.device.on(\"data\", (signal) => {\n\t\t\tvar signalIndex = searchSignalIndex(signal);\n\t\t\tif (signalIndex >= 0) {\n\t\t\t\tvar controllerIndex = Math.floor(signalIndex / 5);\n\t\t\t\tvar buttonIndex = signalIndex % 5;\n\n\t\t\t\tvar key = 'c'+controllerIndex+'b'+buttonIndex;\n\t\t\t\tthis.callHandlers(key, controllerIndex, buttonIndex);\n\n\t\t\t\tkey = 'c'+controllerIndex;\n\t\t\t\tthis.callHandlers(key, controllerIndex, buttonIndex);\n\t\t\t\tthis.callHandlers('all', controllerIndex, buttonIndex);\n\t\t\t}\n\t\t});\n\n\t\tthis.device.on(\"error\", (e) => {\n\t\t\tlet error = new BuzzerReadError(e);\n\t\t\tthis.triggerEvent('error', error);\n\t\t\tthis.triggerEvent('leave', error);\n\t\t});\n\t}\n\n\tleave() {\n\t\tthis.light([0, 1, 2, 3], 0x00);\n\t\tthis.device.close();\n\t}\n\n\tlight(controllerIndexes, value) {\n\t\tif (value != 0x00 && value != 0xFF) {\n\t\t\tthrow new Error(\"light should have a value of 0x0 or 0xFF\")\n\t\t}\n\t\tvar message = [0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0];\n\n\t\tif (typeof(controllerIndexes) == 'number') {\n\t\t\tthis.lights[controllerIndexes] = value;\n\t\t} else {\n\t\t\tfor(var ctrl in controllerIndexes) {\n\t\t\t\tthis.lights[controllerIndexes[ctrl]] = value;\n\t\t\t}\n\t\t}\n\n\t\tfor (var i in this.lights) {\n\t\t\tvar j = parseInt(i, 10)+2;\n\t\t\tmessage[j] = this.lights[i];\n\t\t}\n\n\t\tthis.device.write(message);\n\t}\n\n\tlightOn(controllerIndexes) {\n\t\tthis.light(controllerIndexes, 0xFF);\n\t}\n\n\tlightOff(controllerIndexes) {\n\t\tthis.light(controllerIndexes, 0x0);\n\t}\n\n\tblink(controllerIndexes, times = 5, duration = 150) {\n\t\tvar on = true\n\t\tvar count = 0;\n\t\tvar interval = setInterval(() => {\n\t\t\tif (on) {\n\t\t\t\tif (count > times) {\n\t\t\t\t\tclearInterval(interval);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tthis.lightOn(controllerIndexes);\n\t\t\t\tcount++;\n\t\t\t} else {\n\t\t\t\tthis.lightOff(controllerIndexes);\n\t\t\t}\n\n\t\t\ton = !on;\n\n\t\t}, duration);\n\t}\n\n\tcontrollersCount()/*:number*/ {\n\t\treturn 4;\n\t}\n}\n"]}