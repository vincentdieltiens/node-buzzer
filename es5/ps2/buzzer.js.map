{"version":3,"sources":["ps2/buzzer.js"],"names":["HID","signals","signalsEqual","a","b","i","searchSignalIndex","signal","length","callHandlers","handlers","controllerIndex","buttonIndex","Ps2Buzzer","device","e","message","eventListeners","lights","on","signalIndex","Math","floor","key","forEach","f","event","callback","push","index","indexOf","splice","light","close","controllerIndexes","value","Error","ctrl","j","parseInt","write","times","duration","count","interval","setInterval","clearInterval","lightOn","lightOff","undefined"],"mappings":"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","file":"buzzer.js","sourcesContent":["'use strict';\n\nimport * as HID from 'node-hid';\nimport { BuzzerNotFoundError } from '../BuzzerNotFoundError';\n\nvar signals = [\n\t// controller 1\n\t[0, 0, 1, 0, 240],\n\t[0, 0, 16, 0, 240],\n\t[0, 0, 8, 0, 240],\n\t[0, 0, 4, 0, 240],\n\t[0, 0, 2, 0, 240],\n\t// controller 2\n\t[0, 0, 32, 0, 240],\n\t[0, 0, 0, 2, 240],\n\t[0, 0, 0, 1, 240],\n\t[0, 0, 128, 0, 240],\n\t[0, 0, 64, 0, 240],\n\t// controller 3\n\t[0, 0, 0, 4, 240],\n\t[0, 0, 0, 64, 240],\n\t[0, 0, 0, 32, 240],\n\t[0, 0, 0, 16, 240],\n\t[0, 0, 0, 8, 240],\n\t// controller 4\n\t[0, 0, 0, 128, 240],\n\t[0, 0, 0, 0, 248],\n\t[0, 0, 0, 0, 244],\n\t[0, 0, 0, 0, 242],\n\t[0, 0, 0, 0, 241]\n]\n\nfunction signalsEqual(a, b) {\n\tfor(var i=0; i < 5; i++) {\n\t\tif (a[i] != b[i]) {\n\t\t\treturn false;\n\t\t}\n\t}\n\treturn true;\n}\n\nfunction searchSignalIndex(signal)/*: number*/ {\n\tfor (var i=0; i < signals.length; i++) {\n\t\tif (signalsEqual(signal, signals[i])) {\n\t\t\treturn i;\n\t\t}\n\t}\n\treturn -1;\n}\n\nfunction callHandlers(handlers/*:Array<Function>*/, controllerIndex/*:number*/, buttonIndex/*:number*/) {\n\tif (!handlers) {\n\t\treturn;\n\t}\n\n\tfor (var i in handlers) {\n\t\thandlers[i](controllerIndex, buttonIndex);\n\t}\n}\n\nexport class Ps2Buzzer /*implements Buzzer*/ {\n\t//device/*: HID*/.HID;\n\t//lights/*: Array*/<any>;\n\t//handlers/*: Array*/<Array<Function>>;\n\t//eventListeners: { 'ready': Array<Function>, 'leave': Array<Function> };\n\tconstructor(device) {\n\t\tif (!device) {\n\t\t\ttry {\n\t\t\t\tdevice = new HID.HID(0x054c, 0x1000);\n\t\t\t} catch(e) {\n\t\t\t\tthrow new BuzzerNotFoundError(\"No PS2 Buzzer found :\"+e.message);\n\t\t\t}\n\t\t}\n\t\tthis.device = device\n\n\n\t\tthis.eventListeners = { 'ready': [], 'leave': [] };\n\t\tthis.lights = [0x0, 0x0, 0x0, 0x0]\n\n\t\tthis.handlers = [];\n\t\tthis.device.on(\"data\", (signal) => {\n\t\t\tvar signalIndex = searchSignalIndex(signal);\n\t\t\tif (signalIndex >= 0) {\n\t\t\t\tvar controllerIndex = Math.floor(signalIndex / 5);\n\t\t\t\tvar buttonIndex = signalIndex % 5;\n\n\t\t\t\tvar key = 'c'+controllerIndex+'b'+buttonIndex;\n\t\t\t\tcallHandlers(this.handlers[key], controllerIndex, buttonIndex);\n\n\t\t\t\tkey = 'c'+controllerIndex;\n\t\t\t\tcallHandlers(this.handlers[key], controllerIndex, buttonIndex);\n\n\t\t\t\tcallHandlers(this.handlers['all'], controllerIndex, buttonIndex);\n\t\t\t}\n\t\t});\n\n\t\tthis.device.on(\"error\", () => {\n\t\t\tthis.eventListeners['leave'].forEach((f) => {\n\t\t\t\tf();\n\t\t\t});\n\t\t});\n\t}\n\n\taddEventListener(event/*: string*/, callback/*: Function*/) {\n\t\tthis.eventListeners[event].push(callback);\n\t\tif (event == 'ready') {\n\t\t\tcallback();\n\t\t}\n\t}\n\n\tremoveEventListener(event/*: string*/, callback/*: Function*/) {\n\t\tvar index = this.eventListeners[event].indexOf(callback);\n\t\tthis.eventListeners[event].splice(index, 1);\n\t}\n\n\tleave() {\n\t\tthis.light([0, 1, 2, 3], 0x00);\n\t\tthis.device.close();\n\t}\n\n\tlight(controllerIndexes, value) {\n\t\tif (value != 0x00 && value != 0xFF) {\n\t\t\tthrow new Error(\"light should have a value of 0x0 or 0xFF\")\n\t\t}\n\t\tvar message = [0x0,0x0,0x0,0x0,0x0,0x0,0x0,0x0];\n\n\t\tif (typeof(controllerIndexes) == 'number') {\n\t\t\tthis.lights[controllerIndexes] = value;\n\t\t} else {\n\t\t\tfor(var ctrl in controllerIndexes) {\n\t\t\t\tthis.lights[controllerIndexes[ctrl]] = value;\n\t\t\t}\n\t\t}\n\n\t\tfor (var i in this.lights) {\n\t\t\tvar j = parseInt(i, 10)+2;\n\t\t\tmessage[j] = this.lights[i];\n\t\t}\n\n\t\tthis.device.write(message);\n\t}\n\n\tlightOn(controllerIndexes) {\n\t\tthis.light(controllerIndexes, 0xFF);\n\t}\n\n\tlightOff(controllerIndexes) {\n\t\tthis.light(controllerIndexes, 0x0);\n\t}\n\n\tblink(controllerIndexes, times = 5, duration = 150) {\n\t\tvar on = true\n\t\tvar count = 0;\n\t\tvar interval = setInterval(() => {\n\t\t\tif (on) {\n\t\t\t\tif (count > times) {\n\t\t\t\t\tclearInterval(interval);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tthis.lightOn(controllerIndexes);\n\t\t\t\tcount++;\n\t\t\t} else {\n\t\t\t\tthis.lightOff(controllerIndexes);\n\t\t\t}\n\n\t\t\ton = !on;\n\n\t\t}, duration);\n\t}\n\n\tonPress(callback/*: Function*/, controllerIndex/*: number*/ = undefined, buttonIndex/*: number*/ = undefined)/*: Function*/ {\n\t\tvar key = 'all';\n\t\tif (controllerIndex != undefined || buttonIndex != undefined) {\n\t\t\tkey = '';\n\t\t\tif (controllerIndex != undefined) {\n\t\t\t\tkey = 'c'+controllerIndex;\n\t\t\t}\n\t\t\tif (buttonIndex != undefined) {\n\t\t\t\tkey += 'b'+buttonIndex\n\t\t\t}\n\t\t}\n\n\t\tif (!(key in this.handlers)) {\n\t\t\tthis.handlers[key] = [];\n\t\t}\n\t\tthis.handlers[key].push(callback);\n\t\treturn () => {\n\t\t\tvar index = this.handlers[key].indexOf(callback);\n\t\t\tif (index >= 0) {\n\t\t\t\tthis.handlers[key].splice(index, 1);\n\t\t\t}\n\t\t};\n\t}\n\n\tcontrollersCount()/*:number*/ {\n\t\treturn 4;\n\t}\n}\n"]}