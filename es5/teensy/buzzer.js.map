{"version":3,"sources":["teensy/buzzer.js"],"names":["HID","callHandlers","handlers","controllerIndex","buttonIndex","i","TeensyBuzzer","buzzersCount","devices","deviceInfo","find","d","vendorId","productId","usagePage","usage","device","e","path","eventListeners","on","signal","forEach","f","event","callback","push","index","indexOf","splice","light","close","controllerIndexes","value","Error","indexes","length","message","j","write","times","duration","count","interval","setInterval","clearInterval","lightOn","lightOff","key","undefined"],"mappings":"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","file":"buzzer.js","sourcesContent":["'use strict';\n\n//import { Buzzer } from '../buzzer';\nimport { BuzzerNotFoundError } from '../BuzzerNotFoundError';\nimport * as HID from 'node-hid';\n\nfunction callHandlers(handlers, controllerIndex, buttonIndex) {\n\tif (!handlers) {\n\t\treturn;\n\t}\n\n\tfor (var i in handlers) {\n\t\thandlers[i](controllerIndex, buttonIndex);\n\t}\n}\n\nexport class TeensyBuzzer /*implements Buzzer*/ {\n\t//device: HID.HID;\n\t//eventListeners: { 'ready': Array<Function>, 'leave': Array<Function> };\n\t//handlers: Array<Array<Function>>;\n\t//buzzersCount: number;\n\tconstructor(buzzersCount = 4) {\n\t\tvar devices = HID.devices()\n\t\tvar deviceInfo = devices.find( function(d) {\n\t\t\treturn d.vendorId===0x16C0 \n\t\t\t\t\t&& d.productId===0x0486 \n\t\t\t\t\t&& d.usagePage===0xFFAB \n\t\t\t\t\t&& d.usage===0x200;\n\t\t});\n\t\t\n\t\tif (!deviceInfo) {\n\t\t\ttry {\n\t\t\t\tthis.device = new HID.HID(5824, 1158);\n\t\t\t} catch(e) {\n\t\t\t\tthrow new BuzzerNotFoundError(\"No teensy buzzer found\");\n\t\t\t}\n\t\t} else {\n\t\t\tthis.device = new HID.HID(deviceInfo.path);\n\t\t}\n\n\t\tthis.buzzersCount = buzzersCount;\n\t\tthis.eventListeners = { 'ready': [], 'leave': [] };\n\n\t\tthis.handlers = [];\n\t\tthis.device.on(\"data\", (signal) => {\n\t\t\tvar controllerIndex = signal[0];\n\t\t\tcallHandlers(this.handlers['c'+controllerIndex], controllerIndex, 0);\n\t\t\tcallHandlers(this.handlers['all'], controllerIndex, 0);\n\t\t});\n\n\t\tthis.device.on(\"error\", () => {\n\t\t\tthis.eventListeners['leave'].forEach((f) => {\n\t\t\t\tf();\n\t\t\t});\n\t\t});\n\t}\n\n\taddEventListener(event/*: string*/, callback/*: Function*/) {\n\t\tthis.eventListeners[event].push(callback);\n\t\tif (event == 'ready') {\n\t\t\tcallback();\n\t\t}\n\t}\n\n\tremoveEventListener(event/*: string*/, callback/*: Function*/) {\n\t\tvar index = this.eventListeners[event].indexOf(callback);\n\t\tthis.eventListeners[event].splice(index, 1);\n\t}\n\n\tleave() {\n\t\tfor(var i=0; i < this.buzzersCount; i++) {\n\t\t\tthis.light(i, 0x00);\n\t\t}\n\t\t\n\t\tthis.device.close();\n\t}\n\n\tlight(controllerIndexes, value) {\n\t\tif (value != 0x00 && value != 0xFF) {\n\t\t\tthrow new Error(\"light should have a value of 0x0 or 0xFF\")\n\t\t}\n\n\t\tvar indexes = [];\n\t\tif (typeof(controllerIndexes) == 'number') {\n\t\t\tindexes = [controllerIndexes];\n\t\t} else {\n\t\t\tindexes = controllerIndexes\n\t\t}\n\t\t\n\t\tfor(var i=0; i < indexes.length; i++) {\n\t\t\tvar message = [];\n\t\t\tfor(var j=0; j <= 64; j++) {\n\t\t\t\tmessage[j] = 0x00;\n\t\t\t}\n\t\t\tmessage[0] = 1;\n\t\t\tmessage[1] = indexes[i];\n\t\t\tmessage[2] = value ? 1 : 0;\n\n\t\t\tthis.device.write(message);\n\t\t}\n\t}\n\n\tlightOn(controllerIndexes) {\n\t\tthis.light(controllerIndexes, 0xFF);\n\t}\n\n\tlightOff(controllerIndexes) {\n\t\tthis.light(controllerIndexes, 0x0);\n\t}\n\n\tblink(controllerIndexes, times, duration) {\n\t\tvar on = true\n\t\tvar count = 0;\n\t\tvar interval = setInterval(() => {\n\t\t\tif (on) {\n\t\t\t\tif (count > times) {\n\t\t\t\t\tclearInterval(interval);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tthis.lightOn(controllerIndexes);\n\t\t\t\tcount++;\n\t\t\t} else {\n\t\t\t\tthis.lightOff(controllerIndexes);\n\t\t\t}\n\n\t\t\ton = !on;\n\n\t\t}, duration);\n\t}\n\n\tonPress(callback/*: Function*/, controllerIndex/*: number*/, buttonIndex/*: number*/)/*: Function */{\n\t\tvar key = 'all';\n\t\tif (controllerIndex != undefined || buttonIndex != undefined) {\n\t\t\tkey = '';\n\t\t\tif (controllerIndex != undefined) {\n\t\t\t\tkey = 'c'+controllerIndex;\n\t\t\t}\n\t\t\tif (buttonIndex != undefined) {\n\t\t\t\tkey += 'b'+buttonIndex\n\t\t\t}\n\t\t}\n\n\t\tif (!(key in this.handlers)) {\n\t\t\tthis.handlers[key] = [];\n\t\t}\n\t\tthis.handlers[key].push(callback);\n\t\treturn () => {\n\t\t\tvar index = this.handlers[key].indexOf(callback);\n\t\t\tif (index >= 0) {\n\t\t\t\tthis.handlers[key].splice(index, 1);\n\t\t\t}\n\t\t};\n\t}\n\n\tcontrollersCount()/*:number*/ {\n\t\treturn this.buzzersCount;\n\t}\n\n\n}\n"]}