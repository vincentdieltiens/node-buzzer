{"version":3,"sources":["teensy/buzzer.js"],"names":["HID","getDevice","deviceInfo","path","TeensyBuzzer","buzzersCount","timeout","waitForDevice","devices","find","d","vendorId","productId","usagePage","usage","interval","startTime","Date","now","tick","currentTime","clearInterval","triggerEvent","device","init","e","setInterval","on","signal","controllerIndex","callHandlers","error","i","light","close","controllerIndexes","value","Error","indexes","length","message","j","write","times","duration","count","lightOn","lightOff"],"mappings":"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","file":"buzzer.js","sourcesContent":["'use strict';\n\nimport * as HID from 'node-hid';\nimport { Buzzer } from '../Buzzer';\nimport { BuzzerNotFoundError } from '../BuzzerNotFoundError';\nimport { BuzzerReadError } from '../BuzzerReadError';\n\nfunction getDevice(deviceInfo) {\n\tif (!deviceInfo) {\n\t\treturn new HID.HID(5824, 1158);\n\t} else {\n\t\treturn new HID.HID(deviceInfo.path);\n\t}\n}\n\nexport class TeensyBuzzer extends Buzzer {\n\tconstructor(buzzersCount = 4) {\n\t\tsuper();\n\t\tthis.buzzersCount = buzzersCount;\n\t}\n\n\tconnect(timeout=0) {\n\t\tthis.timeout = timeout;\n\t\tthis.waitForDevice();\n\t}\n\n\twaitForDevice() {\n\t\tvar devices = HID.devices()\n\t\tvar deviceInfo = devices.find( function(d) {\n\t\t\treturn d.vendorId===0x16C0 \n\t\t\t\t\t&& d.productId===0x0486 \n\t\t\t\t\t&& d.usagePage===0xFFAB \n\t\t\t\t\t&& d.usage===0x200;\n\t\t});\n\n\t\tlet interval;\n\t\tlet startTime = Date.now();\n\t\tlet tick = () => {\n\t\t\tlet currentTime = Date.now();\n\t\t\tif (this.timeout > 0 && currentTime - startTime > this.timeout) {\n\t\t\t\tclearInterval(interval);\n\t\t\t\tthis.triggerEvent('error', new BuzzerNotFoundError('Teensy buzzer not found'));\n\t\t\t}\n\n\t\t\ttry {\n\t\t\t\tthis.device = getDevice(deviceInfo);\n\t\t\t\tclearInterval(interval);\n\t\t\t\tthis.init();\n\t\t\t} catch(e) {\n\t\t\t\t// do nothing\n\t\t\t}\n\t\t}\n\t\tinterval = setInterval(tick, 1000);\n\t\ttick();\n\t}\n\n\tinit() {\n\t\tthis.triggerEvent('ready');\n\t\tthis.device.on(\"data\", (signal) => {\n\t\t\tvar controllerIndex = signal[0];\n\t\t\tthis.callHandlers('c'+controllerIndex, controllerIndex, 0);\n\t\t\tthis.callHandlers('all', controllerIndex, 0);\n\t\t});\n\n\t\tthis.device.on(\"error\", (e) => {\n\t\t\tlet error = new BuzzerReadError(e);\n\t\t\tthis.triggerEvent('error', error);\n\t\t\tthis.triggerEvent('leave', error);\n\t\t});\n\t}\n\n\tleave() {\n\t\tfor(var i=0; i < this.buzzersCount; i++) {\n\t\t\tthis.light(i, 0x00);\n\t\t}\n\t\t\n\t\tthis.device.close();\n\t}\n\n\tlight(controllerIndexes, value) {\n\t\tif (value != 0x00 && value != 0xFF) {\n\t\t\tthrow new Error(\"light should have a value of 0x0 or 0xFF\")\n\t\t}\n\n\t\tvar indexes = [];\n\t\tif (typeof(controllerIndexes) == 'number') {\n\t\t\tindexes = [controllerIndexes];\n\t\t} else {\n\t\t\tindexes = controllerIndexes\n\t\t}\n\t\t\n\t\tfor(var i=0; i < indexes.length; i++) {\n\t\t\tvar message = [];\n\t\t\tfor(var j=0; j <= 64; j++) {\n\t\t\t\tmessage[j] = 0x00;\n\t\t\t}\n\t\t\tmessage[0] = 1;\n\t\t\tmessage[1] = indexes[i];\n\t\t\tmessage[2] = value ? 1 : 0;\n\n\t\t\tthis.device.write(message);\n\t\t}\n\t}\n\n\tlightOn(controllerIndexes) {\n\t\tthis.light(controllerIndexes, 0xFF);\n\t}\n\n\tlightOff(controllerIndexes) {\n\t\tthis.light(controllerIndexes, 0x0);\n\t}\n\n\tblink(controllerIndexes, times, duration) {\n\t\tvar on = true\n\t\tvar count = 0;\n\t\tvar interval = setInterval(() => {\n\t\t\tif (on) {\n\t\t\t\tif (count > times) {\n\t\t\t\t\tclearInterval(interval);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tthis.lightOn(controllerIndexes);\n\t\t\t\tcount++;\n\t\t\t} else {\n\t\t\t\tthis.lightOff(controllerIndexes);\n\t\t\t}\n\n\t\t\ton = !on;\n\n\t\t}, duration);\n\t}\n\n\tcontrollersCount()/*:number*/ {\n\t\treturn this.buzzersCount;\n\t}\n\n\n}\n"]}